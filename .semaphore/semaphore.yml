version: v1.0
name: Docker bootstrap
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Make sure that Docker images exist
    task:
      jobs:
      - name: MongoDB + Go Docker images
        commands:
          - checkout
          - cp go.Dockerfile Dockerfile
          - docker build -t s2_go:v1 .
          - mkdir s2_docker
          - docker save s2_go:v1 -o s2_docker/go.tar
          - cp mongoDB.Dockerfile Dockerfile
          - docker build -t s2_mongodb:v1 .
          - docker save s2_mongodb:v1 -o s2_docker/mongodb.tar
          - ls -l s2_docker
          - cache store $SEMAPHORE_PROJECT_ID-$SEMAPHORE_GIT_SHA s2_docker

  - name: Use Docker images
    task:
      jobs:
      - name: Restore from cache and connect
        commands:
          - checkout
          - cache restore $SEMAPHORE_PROJECT_ID-$SEMAPHORE_GIT_SHA
          - ls -l s2_docker
          - docker load s2_docker/go.tar
          - docker load s2_docker/mongodb.tar
          - docker images
          - docker run s2_go:v1
          - docker run -d s2_mongodb:v1 --name my_mongodb

